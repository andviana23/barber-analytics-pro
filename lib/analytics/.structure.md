# üìä M√≥dulo Analytics ‚Äî ETL & C√°lculos

Processamento de dados, c√°lculos de KPIs e detec√ß√£o de anomalias.

## üìÅ Arquivos

### `etl.ts`

- Fun√ß√£o `etlDaily(unitId, runDate)` para execu√ß√£o do ETL
- Busca receitas/despesas do Supabase
- Cria DataFrames com Danfo.js
- Calcula m√©tricas consolidadas
- Salva em `ai_metrics_daily`
- Implementa idempot√™ncia

### `calculations.ts`

- C√°lculo de margem percentual
- C√°lculo de ticket m√©dio
- Saldo acumulado (rolling sum)
- Forecast de fluxo de caixa (m√©dia m√≥vel)
- Compara√ß√£o com targets KPI

### `anomalies.ts`

- Detec√ß√£o de anomalias via z-score
- Detec√ß√£o de quedas significativas (> 10%)
- Detec√ß√£o de margem abaixo do target
- Gera√ß√£o de alertas autom√°ticos

## üîç Exemplo de Uso

```typescript
import { etlDaily } from '@/lib/analytics/etl';

const result = await etlDaily('unit-123', new Date('2025-11-08'));
// Retorna { data: {...}, error: null }
```

## ‚öôÔ∏è Configura√ß√£o

Vari√°veis de ambiente:

- `ANALYTICS_BATCH_SIZE` = 5
- `ANALYTICS_MAX_PARALLEL` = 3
- `ANALYTICS_ETL_TIMEOUT` = 600000ms
- `ANALYTICS_ANOMALY_LOOKBACK_DAYS` = 30
- `ANALYTICS_ANOMALY_ZSCORE_THRESHOLD` = 2
